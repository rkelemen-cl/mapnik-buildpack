#!/bin/bash
set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4
BP_DIR=`dirname $(readlink -f ${BASH_SOURCE%/*})`

# Pack this as well
echo "Supplying mason for further dependencies linkage"
mkdir -p ${DEPS_DIR}/${DEPS_IDX}/mason
curl -sSfL https://github.com/mapbox/mason/archive/v0.20.0.tar.gz | tar -z --extract --strip-components=1 --exclude="*md" --exclude="test*" --directory=${DEPS_DIR}/${DEPS_IDX}/mason

echo "Creating .curlrc"
echo "insecure" > ~/.curlrc

echo "Installing dependencies to $DEPS_DIR/$DEPS_IDX"
${DEPS_DIR}/${DEPS_IDX}/mason/mason install jpeg_turbo 1.5.1 libjpeg
${DEPS_DIR}/${DEPS_IDX}/mason/mason install libpng 1.6.28 libpng
${DEPS_DIR}/${DEPS_IDX}/mason/mason install libtiff 4.0.7 libtiff
${DEPS_DIR}/${DEPS_IDX}/mason/mason install libpq 9.6.2
${DEPS_DIR}/${DEPS_IDX}/mason/mason install sqlite 3.17.0 libsqlite3
${DEPS_DIR}/${DEPS_IDX}/mason/mason install expat 2.2.0 libexpat
${DEPS_DIR}/${DEPS_IDX}/mason/mason install icu 57.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install proj 4.9.3 libproj
${DEPS_DIR}/${DEPS_IDX}/mason/mason install pixman 0.34.0 libpixman-1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install cairo 1.14.8 libcairo
${DEPS_DIR}/${DEPS_IDX}/mason/mason install webp 0.6.0 libwebp
${DEPS_DIR}/${DEPS_IDX}/mason/mason install libgdal 2.1.3 libgdalgit
${DEPS_DIR}/${DEPS_IDX}/mason/mason install boost 1.65.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install boost_libsystem 1.65.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install boost_libfilesystem 1.65.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install boost_libprogram_options 1.65.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install boost_libregex_icu57 1.65.1
${DEPS_DIR}/${DEPS_IDX}/mason/mason install freetype 2.7.1 libfreetype
${DEPS_DIR}/${DEPS_IDX}/mason/mason install harfbuzz 1.4.2-ft libharfbuzz
${DEPS_DIR}/${DEPS_IDX}/mason/mason install mapnik 3.0.21

echo "Dependencies installation completed"
echo "Removing .curlrc"
rm ~/.curlrc

echo "Copying mapnik extension";
cp ${BP_DIR}/deps/mapnik.so ${DEPS_DIR}/${DEPS_IDX}/mapnik.so
